<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="view-transition" content="same-origin" />
  <title>EcoVolt Telemetry</title>

  <!-- App styles -->
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="auth-styles.css" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
    rel="stylesheet" />

  <!-- jQuery DataTables + Responsive -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- uPlot (high-performance charts) -->
  <link rel="stylesheet" href="lib/uplot.min.css" />

  <!-- Configuration - Set your Convex URL here -->
  <script>
    // Detect if running locally or in production
    const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    
    window.CONFIG = window.CONFIG || {
      ABLY_CHANNEL_NAME: "telemetry-dashboard-channel",
      // For local development, use the API key directly
      // In production, use Convex HTTP endpoint for Ably token auth
      ...(isLocal ? {
        ABLY_API_KEY: "DxuYSw.fQHpug:sa4tOcqWDkYBW9ht56s7fT0G091R1fyXQc6mc8WthxQ"
      } : {
        ABLY_AUTH_URL: "https://impartial-walrus-693.convex.site/ably/token"
      }),
      // Set your Convex deployment URL - this is the main data backend
      CONVEX_URL: "https://impartial-walrus-693.convex.cloud",
    };
  </script>
</head>

<body>
  <!-- Floating Action Menu -->
  <div id="fab-menu" class="fab-menu">
    <button id="fab-toggle" class="fab-button liquid-hover" aria-label="Menu">
      <span class="fab-icon">‚ö°</span>
    </button>
    <div id="fab-options" class="fab-options">
      <button id="fab-connect" class="fab-option liquid-hover" data-tooltip="Connect">
        <span>üîó</span>
      </button>
      <button id="fab-export" class="fab-option liquid-hover" data-tooltip="Export">
        <span>üíæ</span>
      </button>
      <button id="fab-sessions" class="fab-option liquid-hover" data-tooltip="Sessions">
        <span>üìä</span>
      </button>
    </div>
  </div>

  <!-- Main Container -->
  <div id="layout" class="app-container">
    <!-- Hero Header -->
    <header class="hero-header">
      <div class="hero-content">
        <div class="hero-title-wrapper">
          <h1 class="hero-title" data-full-text="Shell Eco-marathon" data-short-text="Shell">Shell Eco-marathon</h1>
          <p class="hero-subtitle" data-full-text="Real-time Telemetry Dashboard" data-short-text="DASHBOARD">Real-time
            Telemetry Dashboard</p>
        </div>
        <div class="hero-status">
          <div class="status-badge" id="connection-status">
            <span class="status-dot"></span>
            <span class="status-text">Ready</span>
          </div>
          <div class="stats-mini">
            <div class="stat-mini">
              <span class="stat-mini-value" id="stat-msg">0</span>
              <span class="stat-mini-label">Messages</span>
            </div>
            <div class="stat-mini">
              <span class="stat-mini-value" id="stat-last">Never</span>
              <span class="stat-mini-label">Last Update</span>
            </div>
          </div>
          <!-- Header Actions (Theme + Auth) -->
          <div class="header-actions">
            <button id="theme-toggle" class="theme-toggle liquid-hover" aria-label="Toggle theme"
              title="Toggle light/dark mode">
              <span class="theme-icon theme-icon-sun">‚òÄÔ∏è</span>
              <span class="theme-icon theme-icon-moon">üåô</span>
            </button>
            <!-- Auth button will be inserted here by auth-ui.js -->
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">

      <div class="main">
        <!-- Navigation Tabs -->
        <nav class="tabs-nav">
          <button class="tab active liquid-hover" data-panel="overview">
            <span class="tab-icon">üìä</span>
            <span class="tab-label">Overview</span>
          </button>
          <button class="tab liquid-hover" data-panel="speed">
            <span class="tab-icon">üöó</span>
            <span class="tab-label">Speed</span>
          </button>
          <button class="tab liquid-hover" data-panel="power">
            <span class="tab-icon">‚ö°</span>
            <span class="tab-label">Power</span>
          </button>
          <button class="tab liquid-hover" data-panel="imu">
            <span class="tab-icon">üß≠</span>
            <span class="tab-label">IMU</span>
          </button>
          <button class="tab liquid-hover" data-panel="imu-detail">
            <span class="tab-icon">üéÆ</span>
            <span class="tab-label">IMU Detail</span>
          </button>
          <button class="tab liquid-hover" data-panel="efficiency">
            <span class="tab-icon">üìà</span>
            <span class="tab-label">Efficiency</span>
          </button>
          <button class="tab liquid-hover" data-panel="gps">
            <span class="tab-icon">üó∫Ô∏è</span>
            <span class="tab-label">GPS</span>
          </button>
          <button class="tab liquid-hover" data-panel="custom">
            <span class="tab-icon">üé®</span>
            <span class="tab-label">Custom</span>
          </button>
          <button class="tab liquid-hover" data-panel="data">
            <span class="tab-icon">üìã</span>
            <span class="tab-label">Data</span>
          </button>
        </nav>

        <!-- Overview -->
        <section id="panel-overview" class="panel active">
          <!-- KPIs -->
          <div class="glass-panel mb-4">
            <h3>
              üìä Key Performance Indicators
            </h3>
            <div class="kpi-grid">
              <div class="kpi liquid-hover">
                <div class="kpi-label">üìè Distance</div>
                <div id="kpi-distance" class="kpi-value">0.00 km</div>
              </div>
              <div class="kpi liquid-hover">
                <div class="kpi-label">üèÉ Max Speed</div>
                <div id="kpi-maxspeed" class="kpi-value">0.0 km/h</div>
              </div>
              <div class="kpi liquid-hover">
                <div class="kpi-label">‚ö° Avg Speed</div>
                <div id="kpi-avgspeed" class="kpi-value">0.0 km/h</div>
              </div>
              <div class="kpi liquid-hover">
                <div class="kpi-label">üîã Energy</div>
                <div id="kpi-energy" class="kpi-value">0.00 kWh</div>
              </div>
              <div class="kpi liquid-hover">
                <div class="kpi-label">‚ö° Voltage</div>
                <div id="kpi-voltage" class="kpi-value">0.00 V</div>
              </div>
              <div class="kpi liquid-hover">
                <div class="kpi-label">üîÑ Current</div>
                <div id="kpi-current" class="kpi-value">0.00 A</div>
              </div>
              <div class="kpi liquid-hover">
                <div class="kpi-label">üí° Avg Power</div>
                <div id="kpi-avgpower" class="kpi-value">0.00 W</div>
              </div>
              <div class="kpi liquid-hover">
                <div class="kpi-label">üåä Avg Current</div>
                <div id="kpi-avgcurrent" class="kpi-value">0.00 A</div>
              </div>
            </div>
          </div>

          <!-- Gauges -->
          <div class="glass-panel mb-4">
            <h3>
              üìä Live Performance Gauges
            </h3>
            <div class="gauge-grid">
              <div class="gauge-wrap">
                <div class="gauge" id="gauge-speed"></div>
                <div class="gauge-title">Speed (km/h)</div>
              </div>
              <div class="gauge-wrap">
                <div class="gauge" id="gauge-battery"></div>
                <div class="gauge-title">Battery (%)</div>
              </div>
              <div class="gauge-wrap">
                <div class="gauge" id="gauge-power"></div>
                <div class="gauge-title">Power (W)</div>
              </div>
              <div class="gauge-wrap">
                <div class="gauge" id="gauge-efficiency"></div>
                <div class="gauge-title">Efficiency (km/kWh)</div>
              </div>
              <div class="gauge-wrap">
                <div class="gauge" id="gauge-total-g"></div>
                <div class="gauge-title">G Forces</div>
              </div>
            </div>
          </div>

          <!-- Driver Inputs -->
          <div class="glass-panel driver-box">
            <h3>
              üéÆ Driver Inputs (Live)
            </h3>
            <div class="chart tiny" id="chart-pedals"></div>
            <div class="center fine">Brake and Throttle (0‚Äì100%)</div>
          </div>
        </section>

        <!-- Speed -->
        <section id="panel-speed" class="panel">
          <div class="glass-panel">
            <div class="chart tall" id="chart-speed"></div>
          </div>
        </section>

        <!-- Power -->
        <section id="panel-power" class="panel">
          <div class="glass-panel">
            <div class="chart tall" id="chart-power"></div>
          </div>
        </section>

        <!-- IMU -->
        <section id="panel-imu" class="panel">
          <div class="glass-panel">
            <div class="chart tall" id="chart-imu"></div>
          </div>
        </section>

        <!-- IMU Detail -->
        <section id="panel-imu-detail" class="panel">
          <div class="glass-panel">
            <div class="chart xxl" id="chart-imu-detail"></div>
          </div>
        </section>

        <!-- Efficiency -->
        <section id="panel-efficiency" class="panel">
          <div class="glass-panel">
            <div class="chart tall" id="chart-efficiency"></div>
          </div>
        </section>

        <!-- GPS -->
        <section id="panel-gps" class="panel">
          <div class="split">
            <div class="glass-panel">
              <div class="map" id="map"></div>
            </div>
            <div class="glass-panel">
              <div class="chart" id="chart-altitude"></div>
            </div>
          </div>
        </section>

        <!-- Custom -->
        <section id="panel-custom" class="panel">
          <div class="glass-panel center-content">
            <h3>üé® Custom Charts</h3>
            <p class="fine">
              Click <strong>"Add Chart"</strong> to create custom
              visualizations.
            </p>
            <button id="btn-add-custom-chart" class="liquid-hover mt-2">
              ‚ûï Add Chart
            </button>
          </div>
          <div id="custom-charts-container"></div>
        </section>

        <!-- Data -->
        <section id="panel-data" class="panel">
          <!-- Table first -->
          <div class="data-quality-table">
            <div class="table-header" style="padding: 1.2rem; border-bottom: 1px solid var(--glass-border);">
              <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                üìã Raw Telemetry Data
                <span id="data-count" class="text-subtle small"></span>
              </h3>
            </div>
            <div class="table-wrap">
              <table id="data-table" class="display responsive nowrap" style="width: 100%"></table>
            </div>
          </div>

          <!-- Data Quality Metrics - Redesigned -->
          <div class="quality-metrics-container">
            <!-- Hero Quality Score -->
            <div class="quality-hero glass-panel">
              <div class="quality-hero-score">
                <div class="quality-gauge-ring" id="quality-gauge-ring">
                  <svg viewBox="0 0 120 120">
                    <circle class="gauge-bg" cx="60" cy="60" r="52" />
                    <circle class="gauge-fill" id="quality-gauge-fill" cx="60" cy="60" r="52" />
                  </svg>
                  <div class="quality-gauge-value">
                    <span id="quality-score-hero">0</span>
                    <span class="quality-gauge-unit">%</span>
                  </div>
                </div>
                <div class="quality-hero-label">Quality Score</div>
              </div>
              <div class="quality-hero-stats">
                <div class="quality-stat">
                  <span class="quality-stat-value" id="total-records">0</span>
                  <span class="quality-stat-label">Total Records</span>
                </div>
                <div class="quality-stat">
                  <span class="quality-stat-value" id="complete-records">0%</span>
                  <span class="quality-stat-label">Complete</span>
                </div>
                <div class="quality-stat">
                  <span class="quality-stat-value" id="missing-values">0%</span>
                  <span class="quality-stat-label">Missing</span>
                </div>
              </div>
            </div>

            <!-- Bridge Health Section -->
            <div class="bridge-health glass-panel">
              <h3>
                <span class="bridge-status-dot" id="bridge-status-dot"></span>
                üîó Server Health
              </h3>
              <div class="bridge-health-grid">
                <div class="bridge-metric">
                  <div class="bridge-metric-icon">üì°</div>
                  <div class="bridge-metric-info">
                    <span class="bridge-metric-value" id="bridge-connection-status">Disconnected</span>
                    <span class="bridge-metric-label">Connection</span>
                  </div>
                </div>
                <div class="bridge-metric">
                  <div class="bridge-metric-icon">üîÑ</div>
                  <div class="bridge-metric-info">
                    <span class="bridge-metric-value" id="bridge-reconnects">0</span>
                    <span class="bridge-metric-label">Reconnects</span>
                  </div>
                </div>
                <div class="bridge-metric">
                  <div class="bridge-metric-icon">‚ö†Ô∏è</div>
                  <div class="bridge-metric-info">
                    <span class="bridge-metric-value" id="bridge-error-rate">0/min</span>
                    <span class="bridge-metric-label">Error Rate</span>
                  </div>
                </div>
                <div class="bridge-metric">
                  <div class="bridge-metric-icon">‚ö°</div>
                  <div class="bridge-metric-info">
                    <span class="bridge-metric-value" id="bridge-latency">‚Äî</span>
                    <span class="bridge-metric-label">Latency</span>
                  </div>
                </div>
                <div class="bridge-metric">
                  <div class="bridge-metric-icon">üî¢</div>
                  <div class="bridge-metric-info">
                    <span class="bridge-metric-value" id="bridge-messages-count">0</span>
                    <span class="bridge-metric-label">Since Connect</span>
                  </div>
                </div>
                <div class="bridge-metric">
                  <div class="bridge-metric-icon">‚è±Ô∏è</div>
                  <div class="bridge-metric-info">
                    <span class="bridge-metric-value" id="bridge-last-update">Never</span>
                    <span class="bridge-metric-label">Last Update</span>
                  </div>
                </div>
                <div class="bridge-metric">
                  <div class="bridge-metric-icon">‚úÖ</div>
                  <div class="bridge-metric-info">
                    <span class="bridge-metric-value" id="bridge-uptime-pct">0%</span>
                    <span class="bridge-metric-label">Uptime</span>
                  </div>
                </div>
                <div class="bridge-metric">
                  <div class="bridge-metric-icon">üìä</div>
                  <div class="bridge-metric-info">
                    <span class="bridge-metric-value" id="bridge-data-rate">0/min</span>
                    <span class="bridge-metric-label">Data Pts/min</span>
                  </div>
                </div>
                <div class="bridge-metric">
                  <div class="bridge-metric-icon">üïê</div>
                  <div class="bridge-metric-info">
                    <span class="bridge-metric-value" id="bridge-session-time">0:00</span>
                    <span class="bridge-metric-label">Session Time</span>
                  </div>
                </div>
                <div class="bridge-metric">
                  <div class="bridge-metric-icon">‚ö°</div>
                  <div class="bridge-metric-info">
                    <span class="bridge-metric-value" id="bridge-msg-rate">0 Hz</span>
                    <span class="bridge-metric-label">Live Rate</span>
                  </div>
                </div>
                <div class="bridge-metric">
                  <div class="bridge-metric-icon">üìâ</div>
                  <div class="bridge-metric-info">
                    <span class="bridge-metric-value" id="bridge-median-hz">‚Äî</span>
                    <span class="bridge-metric-label">Median Hz</span>
                  </div>
                </div>
                <div class="bridge-metric">
                  <div class="bridge-metric-icon">üì°</div>
                  <div class="bridge-metric-info">
                    <span class="bridge-metric-value" id="bridge-expected-rate">‚Äî</span>
                    <span class="bridge-metric-label">Message Rate</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Outlier Analysis Panel (NEW) -->
            <div class="outlier-analysis glass-panel">
              <h3>
                <span class="outlier-status-indicator" id="outlier-status-indicator"></span>
                üîç Outlier Analysis
              </h3>
              <!-- Severity Badges -->
              <div class="outlier-severity-row" id="outlier-severity-badges">
                <div class="severity-card critical" id="severity-critical-card">
                  <span class="severity-count" id="outlier-critical-count">0</span>
                  <span class="severity-label">Critical</span>
                </div>
                <div class="severity-card warning" id="severity-warning-card">
                  <span class="severity-count" id="outlier-warning-count">0</span>
                  <span class="severity-label">Warning</span>
                </div>
                <div class="severity-card info" id="severity-info-card">
                  <span class="severity-count" id="outlier-info-count">0</span>
                  <span class="severity-label">Info</span>
                </div>
              </div>
              <!-- Per-Field Outlier Breakdown -->
              <div class="outlier-fields-container" id="outlier-fields-breakdown">
                <div class="outlier-fields-placeholder">No outliers detected</div>
              </div>
              <!-- Recent Outliers Timeline -->
              <div class="outlier-timeline" id="outlier-timeline">
                <h4>Recent Outliers</h4>
                <div class="outlier-timeline-items" id="outlier-timeline-items">
                  <div class="outlier-timeline-empty">No recent outliers</div>
                </div>
              </div>
            </div>

            <!-- Secondary Metrics Row -->
            <div class="quality-secondary-grid">
              <div class="kpi liquid-hover">
                <div class="kpi-label">üîÑ Duplicates</div>
                <div id="duplicate-records" class="kpi-value">0</div>
              </div>
              <div class="kpi liquid-hover">
                <div class="kpi-label">‚ö†Ô∏è Anomalies</div>
                <div id="anomalies-detected" class="kpi-value">0</div>
              </div>
              <div class="kpi liquid-hover">
                <div class="kpi-label">üìâ Dropouts</div>
                <div id="dropout-count" class="kpi-value">0</div>
              </div>
              <div class="kpi liquid-hover">
                <div class="kpi-label">‚è≥ Max Gap</div>
                <div id="max-gap-value" class="kpi-value">N/A</div>
              </div>
            </div>

            <!-- Quality Alerts (always visible when present) -->
            <div id="quality-alerts" class="note-list"></div>

            <!-- Quality Score Trend Chart -->
            <div class="glass-panel quality-trend-chart">
              <h4>üìà Quality Score Trend</h4>
              <div class="chart h-200" id="chart-quality-score"></div>
            </div>

            <!-- Collapsible Sections -->
            <div class="collapsible-sections">
              <!-- Field Completeness (moved to bottom) -->
              <details class="collapsible-section">
                <summary class="collapsible-header">
                  <span class="collapsible-icon">üìä</span>
                  <span class="collapsible-title">Field Completeness</span>
                  <span class="collapsible-arrow">‚ñº</span>
                </summary>
                <div class="collapsible-content">
                  <div id="field-completeness" class="field-bars"></div>
                </div>
              </details>
            </div>
          </div>
        </section>
      </div>

      <footer class="footer">
        <div class="glass-panel footer-panel">
          <p class="fine">
            üèéÔ∏è Shell Eco-marathon Telemetry Dashboard
          </p>
        </div>
      </footer>
    </main>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Ably realtime for telemetry streaming -->
  <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>

  <!-- Convex browser client for real-time data & auth -->
  <script src="https://unpkg.com/convex@1.17.0/dist/browser.bundle.js"></script>

  <!-- Auth modules -->
  <script src="auth.js"></script>
  <script src="auth-ui.js"></script>

  <!-- High-performance charting (uPlot) -->
  <script src="lib/uplot.iife.min.js"></script>
  <script src="lib/gauges.js"></script>
  <script src="lib/charts.js"></script>
  <script src="lib/mock-data.js"></script>
  <script src="lib/worker-bridge.js"></script>
  <script src="lib/convex-bridge.js"></script>

  <!-- App logic -->
  <script src="app.js"></script>

  <!-- View Transitions API Polyfill -->
  <script>
    // Polyfill for browsers that don't support View Transitions API
    if (!document.startViewTransition) {
      document.startViewTransition = (callback) => {
        callback();
      };
    }
  </script>
</body>

</html>
